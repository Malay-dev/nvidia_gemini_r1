FROM dustynv/ros:noetic-desktop-l4t-r32.7.1

RUN apt-get update && apt-get install -y \
    git \
    software-properties-common \
    python3-pip && \
    apt-get clean
    
RUN apt-get update && apt-get install -y \
    ros-noetic-effort-controllers \
    ros-noetic-teleop-twist-keyboard \
    ros-noetic-foxglove-bridge && \
    apt-get clean

RUN mkdir -p /root/catkin_ws/src

COPY ./src /root/catkin_ws/src
COPY ./gemini_run.py /root/
COPY ./requirements.txt /root/

RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && \
    cd /root/catkin_ws && \
    if [ -f src/CMakeLists.txt ]; then catkin_make; else echo 'No valid src found, skipping build'; fi"

RUN python3.8 -m pip install -r /root/requirements.txt

RUN python3.9 -m pip install -r /root/requirements.txt

RUN echo "source /root/catkin_ws/devel/setup.bash" >> /root/.bashrc

RUN echo "source /opt/ros/noetic/setup.bash" >> /root/.bashrc

CMD roslaunch foxglove_bridge foxglove_bridge.launch & bash
